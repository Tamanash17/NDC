# Critical Fixes - January 10, 2026

## Session Summary
This document details critical fixes implemented to resolve OF4053 errors and improve SSR display in the Jetstar NDC booking engine.

---

## 1. OF4053 Error Fix - Journey Reference Array Type Mismatch

### Problem
When selecting bundle P200 or M202 for BOTH outbound and inbound flights, OfferPrice returned error OF4053:
```
Error encountered selling SSRs for service bundle P200 - for journey 20260111 JQ 612 AVVSYD, 20260112 JQ 39 SYDDPS, 20260112 JQ 43 DPSSIN
```

### Root Cause
**Critical Type Mismatch**: Frontend interface used singular `journeyRefId: string` but backend expected plural `journeyRefIds: string[]`

This caused BOTH bundle items to use the SAME journey reference ID instead of separate IDs:
```xml
<!-- WRONG - Both bundles using fl2033916944 -->
<PaxJourneyRefID>fl2033916944</PaxJourneyRefID>  <!-- Outbound bundle -->
<PaxJourneyRefID>fl2033916944</PaxJourneyRefID>  <!-- Inbound bundle -->

<!-- CORRECT - Each bundle gets its own journey ref -->
<PaxJourneyRefID>fl2033916944</PaxJourneyRefID>  <!-- Outbound -->
<PaxJourneyRefID>fl34748140</PaxJourneyRefID>    <!-- Inbound -->
```

### Solution
**File**: `c:\Booking Engine\frontend\src\steps\offer-price\OfferPriceStep.tsx`

#### Change 1: Fixed BundleInfo Interface (Line 293)
```typescript
// BEFORE (WRONG)
interface BundleInfo {
  bundleId: string;
  offerId: string;
  paxRefIds: string[];
  journeyRefId: string;  // ❌ SINGULAR - only stores one ID
  paxOfferItemIds?: Record<string, string>;
}

// AFTER (CORRECT)
interface BundleInfo {
  bundleId: string;
  offerId: string;
  paxRefIds: string[];
  journeyRefIds: string[];  // ✅ PLURAL ARRAY - stores all journey IDs
  paxOfferItemIds?: Record<string, string>;
}
```

#### Change 2: Use Correct Journey Index for Outbound (Line 1140)
```typescript
// Outbound bundle uses journeyRefs[0]
const swapJourneyRef = outboundBundleSwap.journeyRefs?.[0];
```

#### Change 3: Use Correct Journey Index for Inbound (Line 1212)
```typescript
// Inbound bundle uses journeyRefs[1] with fallback to [0]
const swapJourneyRef = inboundBundleSwap.journeyRefs?.[1] || inboundBundleSwap.journeyRefs?.[0];
```

#### Change 4: Wrap Journey IDs in Arrays (Lines 1159, 1186, 1227, 1254)
```typescript
// BEFORE (WRONG)
journeyRefId: journeyRefId,  // Singular property, single value

// AFTER (CORRECT)
journeyRefIds: [journeyRefId],  // Plural property, array value
```

### Backend Processing
**File**: `c:\Booking Engine\backend\src\builders\offer-price.builder.ts` (Lines 112-142)

The backend correctly loops through the `journeyRefIds` array and creates ONE `SelectedOfferItem` per journey:
```typescript
if (item.associationType === 'journey' && item.journeyRefIds?.length > 0) {
  refs = item.journeyRefIds;
  refType = 'journey';
}

// Create ONE SelectedOfferItem per ref
for (const ref of refs) {
  expandedItems.push(`
    <SelectedOfferItem>
      <OfferItemRefID>${escapeXml(item.offerItemId)}</OfferItemRefID>
      ${paxRefIdsXml}${buildALaCarteOfferItemWithRef(refType, ref)}
    </SelectedOfferItem>`);
}
```

### Testing
To verify the fix:
1. Search for a round trip flight with multiple segments (e.g., VIZ → SIN with layovers)
2. Select bundle P200 or M202 for BOTH outbound and inbound flights
3. Check XML logs - each bundle should have its unique journey reference ID
4. OfferPrice should succeed without OF4053 error

---

## 2. Journey-Level SSR Grouping (Duplicate Baggage Fix)

### Problem
ServiceList displayed 3 identical "10kg Bag" items for a 3-segment journey because Jetstar's NDC API returns SSRs on a per-segment basis:
- Segment 1 (AVV→SYD): 10kg Bag
- Segment 2 (SYD→DPS): 10kg Bag
- Segment 3 (DPS→SIN): 10kg Bag

This created a confusing UX with duplicate items.

### Solution
**File**: `c:\Booking Engine\frontend\src\steps\service-list\ServiceListStep.tsx` (Lines 1082-1122)

Implemented journey-level SSR grouping that:
1. Merges duplicate SSRs with identical service code, price, direction, and name
2. Combines all segment/journey/leg references into arrays
3. Displays ONE card per unique SSR per journey to users
4. Maintains internal segment associations for API compatibility

```typescript
// Journey-level SSR grouping: Merge segment-based duplicates for user display
// while maintaining internal segment associations for API
const uniqueServices = new Map<string, Service>();
for (const svc of processedServices) {
  const key = `${svc.serviceCode}-${svc.price}-${svc.direction}-${svc.serviceName}`;

  if (!uniqueServices.has(key)) {
    // First occurrence - add as-is
    uniqueServices.set(key, svc);
  } else {
    // Duplicate found - merge segment/journey references
    const existing = uniqueServices.get(key)!;

    // Merge segmentRefs (for internal API structure)
    if (svc.segmentRefs && svc.segmentRefs.length > 0) {
      existing.segmentRefs = [...(existing.segmentRefs || []), ...svc.segmentRefs];
    }

    // Merge journeyRefs (for internal API structure)
    if (svc.journeyRefs && svc.journeyRefs.length > 0) {
      existing.journeyRefs = [...(existing.journeyRefs || []), ...svc.journeyRefs];
    }

    // Merge legRefs (for internal API structure)
    if (svc.legRefs && svc.legRefs.length > 0) {
      existing.legRefs = [...(existing.legRefs || []), ...svc.legRefs];
    }

    // Keep track of merged offerItemIds for API request
    if (svc.offerItemId && existing.offerItemId !== svc.offerItemId) {
      existing.offerItemId = existing.offerItemId.includes(',')
        ? `${existing.offerItemId},${svc.offerItemId}`
        : `${existing.offerItemId},${svc.offerItemId}`;
    }

    console.log(`[ServiceListStep] Merged duplicate SSR: ${svc.serviceCode} ${svc.serviceName} - combined ${existing.segmentRefs?.length || 0} segments`);
  }
}
```

### How It Works

#### User Display
- Shows ONE "10kg Bag" card per journey (not 3 identical cards)
- User selects the SSR once for the entire journey

#### Internal API Structure
When user selects the SSR, the service contains:
```typescript
{
  serviceCode: 'BG10',
  serviceName: '10kg Bag',
  associationType: 'segment',  // ✅ Preserved marker
  segmentRefs: ['seg1', 'seg2', 'seg3'],  // ✅ All 3 segments merged
  // ... other properties
}
```

#### Backend Processing
**File**: `c:\Booking Engine\backend\src\builders\offer-price.builder.ts` (Lines 112-142)

Backend reads `associationType` and expands the merged refs:
```typescript
// Determine which refs to use based on association type
if (item.associationType === 'journey' && item.journeyRefIds?.length > 0) {
  refs = item.journeyRefIds;
  refType = 'journey';
} else if (item.associationType === 'leg' && item.legRefIds?.length > 0) {
  refs = item.legRefIds;
  refType = 'leg';
} else if (item.segmentRefIds?.length > 0) {
  refs = item.segmentRefIds;  // ✅ Uses merged segment array
  refType = 'segment';
}

// Create ONE SelectedOfferItem per segment
for (const ref of refs) {  // ✅ Loops through all 3 segments
  expandedItems.push(`
    <SelectedOfferItem>
      <OfferItemRefID>${escapeXml(item.offerItemId)}</OfferItemRefID>
      ${paxRefIdsXml}${buildALaCarteOfferItemWithRef(refType, ref)}
    </SelectedOfferItem>`);
}
```

This creates 3 separate `SelectedOfferItem` entries in the OfferPrice XML request, one per segment.

### Applies to All SSR Types
This grouping logic works for:
- **Segment-based SSRs**: Baggage (BG10, BG15, BG20, etc.)
- **Journey-based SSRs**: Bundle upgrades, priority boarding, etc.
- **Leg-based SSRs**: Seat selections, meal preferences, etc.

The `associationType` property is preserved and correctly used by the backend to determine which refs array to expand.

---

## 3. Previous Fixes (Earlier in Session)

### Bundle Codes Display
**File**: `c:\Booking Engine\frontend\src\components\flights\FlightRow.tsx` (Line 334)

Added bundle codes in brackets next to bundle names:
```typescript
{cleanName(bundle.bundleName)}{bundle.bundleCode ? ` (${bundle.bundleCode})` : ''}
```

Display: "Starter Plus (P200)", "Max (M202)", "Flex (F202)"

### Currency Symbol Fix
**File**: `c:\Booking Engine\frontend\src\lib\format.ts` (Lines 4-32)

Added locale mapping for correct currency symbols (₹ for INR instead of $):
```typescript
const localeMap: Record<string, string> = {
  'AUD': 'en-AU',
  'USD': 'en-US',
  'INR': 'en-IN',  // ✅ Use Indian locale for ₹ symbol
  'SGD': 'en-SG',
  // ... 10 more currencies
};
```

### Backend Currency Defaults
**File**: `c:\Booking Engine\backend\src\parsers\offer-price.parser.ts`

Fixed currency fallback to use request currency instead of hardcoded AUD.

### OF4053 Error Handling
**File**: `c:\Booking Engine\backend\src\routes\ndc.routes.ts` (Lines 358-419)

Added detection for OF4053 bundle SSR errors with user-friendly messaging.

---

## Key Architecture Patterns

### 1. Association Type Pattern
SSRs have an `associationType` property that determines how they're linked to flights:
- `'segment'`: Per flight segment (most baggage)
- `'journey'`: Per complete journey (some bundles)
- `'leg'`: Per flight leg (some seat selections)

**Critical**: Always preserve `associationType` when processing SSRs. The backend uses this to determine which refs array to expand.

### 2. Reference Arrays Pattern
SSRs maintain three parallel reference arrays:
- `segmentRefs[]`: Segment IDs
- `journeyRefs[]`: Journey IDs
- `legRefs[]`: Leg IDs

Backend uses `associationType` to pick the correct array and expands it into separate `SelectedOfferItem` entries.

### 3. Bundle Journey References Pattern
For round trips, bundles contain BOTH journey references:
- `journeyRefs[0]`: Outbound journey ID
- `journeyRefs[1]`: Inbound journey ID

When splitting bundles for UI display, use the correct index:
```typescript
// Outbound bundle
journeyRefIds: [bundle.journeyRefs?.[0]]

// Inbound bundle
journeyRefIds: [bundle.journeyRefs?.[1] || bundle.journeyRefs?.[0]]
```

### 4. ServiceList to OfferPrice Flow
1. **ServiceList Response**: Returns services with segment/journey/leg refs
2. **Frontend Grouping**: Merges duplicates, combines refs into arrays
3. **User Selection**: User picks ONE item per unique service per journey
4. **Frontend Packaging**: Sends merged service with all refs + associationType
5. **Backend Expansion**: Loops through refs array, creates multiple SelectedOfferItem entries
6. **OfferPrice Request**: Contains correct number of items per segment/journey/leg

---

## Testing Checklist

### OF4053 Fix Verification
- [ ] Search VIZ → SIN round trip (multi-segment route)
- [ ] Select P200 bundle for outbound flight
- [ ] Select P200 bundle for inbound flight
- [ ] Verify OfferPrice succeeds (no OF4053 error)
- [ ] Check XML logs show different journey IDs per bundle

### Journey-Level SSR Verification
- [ ] After flight selection, go to ServiceList
- [ ] Verify only ONE "10kg Bag" shows per journey (not 3)
- [ ] Select baggage for outbound journey
- [ ] Proceed to OfferPrice
- [ ] Check XML logs show 3 separate SelectedOfferItem entries (one per segment)
- [ ] Verify OfferPrice succeeds with correct pricing

### Currency Display Verification
- [ ] Search with INR currency
- [ ] Verify ₹ symbol displays (not $)
- [ ] Check all price locations: flight cards, bundles, grand total
- [ ] Test with other currencies (SGD, USD, AUD)

---

## Files Modified

### Critical Files (OF4053 Fix)
1. `c:\Booking Engine\frontend\src\steps\offer-price\OfferPriceStep.tsx`
   - Line 293: BundleInfo interface type change
   - Lines 1140, 1212: Journey index selection
   - Lines 1159, 1186, 1227, 1254: Array wrapping

### Critical Files (SSR Grouping)
2. `c:\Booking Engine\frontend\src\steps\service-list\ServiceListStep.tsx`
   - Lines 1082-1122: Journey-level deduplication logic

### Backend Files (Reference - No Changes)
3. `c:\Booking Engine\backend\src\builders\offer-price.builder.ts`
   - Lines 112-142: Ref expansion logic (already correct)

### UI/Display Files
4. `c:\Booking Engine\frontend\src\components\flights\FlightRow.tsx`
   - Line 334: Bundle code display
5. `c:\Booking Engine\frontend\src\lib\format.ts`
   - Lines 4-32: Currency locale mapping

---

## Common Pitfalls to Avoid

### 1. Don't Mix Singular/Plural Property Names
```typescript
// ❌ BAD - Inconsistent naming
interface BundleInfo {
  journeyRefId: string;  // Singular name
}
// Backend expects: journeyRefIds: string[]

// ✅ GOOD - Consistent naming
interface BundleInfo {
  journeyRefIds: string[];  // Plural name matches backend
}
```

### 2. Don't Forget Array Wrapping
```typescript
// ❌ BAD - Passing single value to array property
journeyRefIds: journeyRefId

// ✅ GOOD - Wrap in array
journeyRefIds: [journeyRefId]
```

### 3. Don't Drop associationType
```typescript
// ❌ BAD - Lost association marker
const mergedService = {
  serviceCode: svc.serviceCode,
  segmentRefs: [...refs],
  // associationType missing!
};

// ✅ GOOD - Preserve marker
const mergedService = {
  serviceCode: svc.serviceCode,
  segmentRefs: [...refs],
  associationType: svc.associationType,  // Keep this!
};
```

### 4. Don't Use Wrong Journey Index
```typescript
// ❌ BAD - Both using same index
outboundJourneyRef: bundle.journeyRefs?.[0]
inboundJourneyRef: bundle.journeyRefs?.[0]  // Wrong!

// ✅ GOOD - Different index per direction
outboundJourneyRef: bundle.journeyRefs?.[0]
inboundJourneyRef: bundle.journeyRefs?.[1] || bundle.journeyRefs?.[0]
```

---

## Debug Tips

### Enable Console Logging
Look for these log messages:

**ServiceList Merging**:
```
[ServiceListStep] Merged duplicate SSR: BG10 10kg Bag - combined 3 segments
```

**OfferPrice Building**:
```
[OfferPriceBuilder] Offer X using per-item paxRefIds
```

### Check XML Logs
**Directory**: `c:\Users\taman\Downloads\NDC_Session_*\`

**Look for**:
- `06_OfferPrice_RQ_*.xml`: Request sent to API
- `06_OfferPrice_RS_*.xml`: Response from API

**In Request XML, verify**:
```xml
<!-- For bundles - different journey refs -->
<SelectedOffer>
  <OfferRefID>offer-outbound</OfferRefID>
  <SelectedALaCarteOfferItem>
    <PaxJourneyRef>
      <PaxJourneyRefID>fl2033916944</PaxJourneyRefID>  <!-- Outbound -->
    </PaxJourneyRef>
  </SelectedALaCarteOfferItem>
</SelectedOffer>
<SelectedOffer>
  <OfferRefID>offer-inbound</OfferRefID>
  <SelectedALaCarteOfferItem>
    <PaxJourneyRef>
      <PaxJourneyRefID>fl34748140</PaxJourneyRefID>  <!-- Inbound - DIFFERENT -->
    </PaxJourneyRef>
  </SelectedALaCarteOfferItem>
</SelectedOffer>

<!-- For baggage - multiple segment refs -->
<SelectedOffer>
  <OfferRefID>offer-baggage</OfferRefID>
  <SelectedOfferItem>
    <OfferItemRefID>bg10-item-1</OfferItemRefID>
    <SelectedALaCarteOfferItem>
      <OfferFlightAssociations>
        <PaxSegmentRef>
          <PaxSegmentRefID>seg1</PaxSegmentRefID>  <!-- Segment 1 -->
        </PaxSegmentRef>
      </OfferFlightAssociations>
    </SelectedALaCarteOfferItem>
  </SelectedOfferItem>
  <SelectedOfferItem>
    <OfferItemRefID>bg10-item-2</OfferItemRefID>
    <SelectedALaCarteOfferItem>
      <OfferFlightAssociations>
        <PaxSegmentRef>
          <PaxSegmentRefID>seg2</PaxSegmentRefID>  <!-- Segment 2 -->
        </PaxSegmentRef>
      </OfferFlightAssociations>
    </SelectedALaCarteOfferItem>
  </SelectedOfferItem>
  <SelectedOfferItem>
    <OfferItemRefID>bg10-item-3</OfferItemRefID>
    <SelectedALaCarteOfferItem>
      <OfferFlightAssociations>
        <PaxSegmentRef>
          <PaxSegmentRefID>seg3</PaxSegmentRefID>  <!-- Segment 3 -->
        </PaxSegmentRef>
      </OfferFlightAssociations>
    </SelectedALaCarteOfferItem>
  </SelectedOfferItem>
</SelectedOffer>
```

---

## Future Considerations

### 1. Performance Optimization
The current SSR grouping implementation uses a Map for deduplication. For very large ServiceList responses (100+ services), consider:
- Pre-sorting services by code before grouping
- Batch processing for large ref arrays
- Caching merged services across re-renders

### 2. Enhanced Error Messages
If OF4053 still occurs after these fixes, potential causes:
- Airline changed bundle availability between AirShopping and OfferPrice
- Segment references changed due to schedule updates
- Bundle codes don't match across requests

Add more detailed logging in these cases.

### 3. Alternative Grouping Strategies
Current implementation groups by: `serviceCode + price + direction + serviceName`

Consider alternative keys if needed:
- Add `weight` for baggage: Different weights should show separately
- Add `rfic/rfisc` codes: Different service categories
- Add `description`: More granular grouping

### 4. UI Enhancements
Consider showing segment count in UI:
```typescript
{svc.serviceName} {svc.segmentRefs?.length > 1 ? `(${svc.segmentRefs.length} segments)` : ''}
```

Display: "10kg Bag (3 segments)"

---

## Contact & Support

**Implementation Date**: January 10, 2026
**Tested With**: Jetstar NDC API v21.3
**Test Route**: VIZ → SIN (multi-segment with layovers)
**Test Bundles**: P200 (Starter Plus), M202 (Max)

For questions or issues, refer to:
- Backend builder: `offer-price.builder.ts` lines 100-147
- Frontend bundler: `OfferPriceStep.tsx` lines 1100-1300
- ServiceList parser: `ServiceListStep.tsx` lines 900-1200

---

**End of Documentation**
